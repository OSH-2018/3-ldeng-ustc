# 内存文件系统

本程序实现了一个简单的定长（4GB）单目录的内存文件系统。

## 名词定义

### 内存块

使用mmap分配的一块内存，简称为块。在本系统中大小为65536 Byte（Blocksize）。

### 信息块

用于储存filenode的内存块。这个结构大小为256 Bytes，故每个块中可储存256个节点。

### 数据块

用于储存文件内容的块。

## 类型定义

### 循环队列（Queue）

一个简单的循环队列实现，可以指定队列数据和队头、队尾的储存位置。作为模版类，可指定元素类型和最长长度。

### 哈希表（Hashmap）

一个简单实现的闭散列哈希表。可以通过std::string检索到内存位置。

### 块编号 （MemNo）

``uint16_t`` 的别名，0~65535,与内存块一一对应。

### 块内位置 （BlockPos）

``uint8_t`` 的别名，0~255,与信息块中节点位置一一对应。

### 内存位置（Location）

``pair<MemNo,BlockPos>`` 的别名，用于标示某一文件节点的位置。由于数据对齐的原因，该类形大小为4 Bytes，这点需要注意。

### 文件节点 （Filenode）

按值（而非指针）存储了文件名（``char filename[104]``）、文件状态（``struct stat st``）、文件内容起始位置（``Location content``）以及下个文件节点位置(``Location next``)。由于对齐，结构体中的成员定义顺序不能随意更改，该结构体大小正好为256 Bytes。值得注意的是，此处限定了文件名不得超过103个字符。

### 基本星系 （BasicInfo)

储存了文件系统的基本信息的结构体。

## 块定义

本文件系统块数量一定，设为65536（Blocknr）块，从 0 至 65535 编号，记为mem[0]至mem[65536]，每块大小为65536 Byte（Blocksize）。未使用的块不分配内存，需要使用时使用mmap从内存中分配，各块定义如下。

* mem[0] ：类型：``BasicInfo`` ，储存整个系统共用的信息。 
* mem[1] - mem[2] ：类型：``Queue<MemNo>`` ，循环队列，储存未被使用的块编号。
* mem[3] - mem[6] ：类型：``Queue<Location>``，循环队列，储存被分配为信息块的块中未被使用的内存位置。
* mem[7] ：类型：``uint8_t[Blocknr]``，引用计数，被分配为信息块的内存块中已使用的位置数量，用于回收利用。溢出不可怕，强行使用它。0既可以代表256也可以代表0,根据是新写入信息后还是新删除信息后来判断。这个计数不用与判断位置是否被使用，只用于判断整个块是否为全空。
* mem[8] - mem[9] ：类型：``MemNo[Blocknr]``，线性表，储存作为文件数据块的链表数据，即对应编号数据块在数据上连续的块编号，若无则置为0。
* mem[10] - mem[15] ：类型：``Hashmap``，哈希表，用于文件名到文件位置的检索。
* mem[16] - mem[65535] ：无特定用处的块，将会被分配为数据块或信息块


